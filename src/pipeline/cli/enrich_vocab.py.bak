"""CLI for vocabulary enrichment.

Usage:
    python -m src.pipeline.cli.enrich_vocab \\
        --language zh \\
        --level HSK1 \\
        --input data/mandarin_hsk1.tsv \\
        --enricher mandarin \\
        --output output/mandarin/hsk1/vocab.json \\
        --max-items 10 \\
        --dry-run

Supports:
- Mandarin Chinese (--enricher mandarin, TSV input)
- Japanese (--enricher japanese, JSON input)
- French (--enricher french, CSV input)
"""

import argparse
from dotenv import load_dotenv
import logging
import sys
import time
from pathlib import Path

from src.pipeline.enrichers.vocab import (
    FrenchVocabEnricher,
    JapaneseVocabEnricher,
    MandarinVocabEnricher,
)
from src.pipeline.prompts.mandarin import vocab_prompts as mandarin_prompts
from src.pipeline.prompts.japanese import vocab_prompts as japanese_prompts
from src.pipeline.prompts.french import vocab_prompts as french_prompts
from src.pipeline.utils.file_io import write_json
from src.pipeline.utils.llm_client import LLMClient
from src.pipeline.utils.logging_config import configure_logging
from src.pipeline.validators.schema import LearningItem, LevelSystem

logger = logging.getLogger(__name__)

load_dotenv()


def parse_args() -> argparse.Namespace:
    """Parse command-line arguments."""
    parser = argparse.ArgumentParser(
        description="Enrich vocabulary items with LLM-generated content",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Enrich Mandarin HSK1 vocabulary
  python -m src.pipeline.cli.enrich_vocab \\
      --language zh --level HSK1 \\
      --input data/hsk1_vocab.tsv \\
      --enricher mandarin \\
      --output output/zh/hsk1/vocab.json

  # Enrich Japanese N5 vocabulary (dry run, 5 items)
  python -m src.pipeline.cli.enrich_vocab \\
      --language ja --level N5 \\
      --input data/jlpt_n5.json \\
      --enricher japanese \\
      --output output/ja/n5/vocab.json \\
      --dry-run --max-items 5

  # Enrich French A1 vocabulary
  python -m src.pipeline.cli.enrich_vocab \\
      --language fr --level A1 \\
      --input data/french_a1.csv \\
      --enricher french \\
      --output output/fr/a1/vocab.json
        """,
    )

    parser.add_argument(
        "--language",
        required=True,
        choices=["zh", "ja", "fr", "en", "es"],
        help="Target language ISO code",
    )

    parser.add_argument(
        "--level",
        required=True,
        help="Proficiency level (HSK1-HSK6, N5-N1, A1-C1)",
    )

    parser.add_argument(
        "--input",
        required=True,
        type=Path,
        help="Input file path (TSV for Mandarin, JSON for Japanese, CSV for French)",
    )

    parser.add_argument(
        "--enricher",
        required=True,
        choices=["mandarin", "japanese", "french"],
        help="Enricher to use (must match language)",
    )

    parser.add_argument(
        "--output",
        required=True,
        type=Path,
        help="Output JSON file path",
    )

    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Parse input and show preview without calling LLM",
    )

    parser.add_argument(
        "--max-items",
        type=int,
        default=None,
        help="Maximum number of items to process (for testing)",
    )

    parser.add_argument(
        "--manual-review-dir",
        type=Path,
        default=None,
        help="Directory for manual review queue (default: output_dir/manual_review)",
    )

    parser.add_argument(
        "--log-level",
        default="INFO",
        choices=["DEBUG", "INFO", "WARNING", "ERROR"],
        help="Logging level",
    )

    return parser.parse_args()


def get_enricher_class(enricher_name: str):
    """Get enricher class by name."""
    enrichers = {
        "mandarin": MandarinVocabEnricher,
        "japanese": JapaneseVocabEnricher,
        "french": FrenchVocabEnricher,
    }

    return enrichers.get(enricher_name)


def determine_level_system(language: str) -> LevelSystem:
    """Determine level system based on language.

    Args:
        language: ISO language code (zh, ja, fr, en, es)

    Returns:
        LevelSystem enum value
    """
    level_system_map = {
        "zh": LevelSystem.HSK,
        "ja": LevelSystem.JLPT,
        "fr": LevelSystem.CEFR,
        "en": LevelSystem.CEFR,
        "es": LevelSystem.CEFR,
    }

    return level_system_map.get(language, LevelSystem.CEFR)


def main() -> int:
    """Main CLI entry point."""
    args = parse_args()

    # Setup logging
    configure_logging(
        level=getattr(logging, args.log_level),
        json_format=False,  # Use simple format for CLI
        console_output=True,
    )

    logger.info("=" * 80)
    logger.info("Vocabulary Enrichment Pipeline")
    logger.info("=" * 80)
    logger.info(f"Language: {args.language}")
    logger.info(f"Level: {args.level}")
    logger.info(f"Enricher: {args.enricher}")
    logger.info(f"Input: {args.input}")
    logger.info(f"Output: {args.output}")
    logger.info(f"Dry Run: {args.dry_run}")
    if args.max_items:
        logger.info(f"Max Items: {args.max_items}")
    logger.info("=" * 80)

    # Validate input file exists
    if not args.input.exists():
        logger.error(f"Input file not found: {args.input}")
        return 1

    # Get enricher class
    enricher_class = get_enricher_class(args.enricher)
    if not enricher_class:
        logger.error(f"Unknown enricher: {args.enricher}")
        return 1

    # Determine level system
    level_system = determine_level_system(args.language)

    # Setup manual review directory
    manual_review_dir = args.manual_review_dir or (
        args.output.parent / "manual_review"
    )

    # Initialize enricher
    if args.dry_run:
        logger.info("DRY RUN MODE: No LLM calls will be made")
        enricher = enricher_class(
            llm_client=None,  # type: ignore
            manual_review_dir=manual_review_dir,
        )
    else:
        llm_client = LLMClient()
        enricher = enricher_class(
            llm_client=llm_client,
            max_retries=3,
            manual_review_dir=manual_review_dir,
        )

    # Parse source file
    logger.info(f"Parsing source file: {args.input}")
    start_time = time.time()

    try:
        items = enricher.parse_source(args.input)
    except Exception as e:
        logger.error(f"Failed to parse source file: {e}", exc_info=True)
        return 1

    parse_time = time.time() - start_time
    logger.info(f"Parsed {len(items)} items in {parse_time:.2f}s")

    # Limit items if max_items specified
    if args.max_items:
        items = items[: args.max_items]
        logger.info(f"Limited to {len(items)} items for processing")

    # Dry run: show preview and exit
    if args.dry_run:
        logger.info("\n" + "=" * 80)
        logger.info("DRY RUN PREVIEW (first 3 items):")
        logger.info("=" * 80)

        for i, item in enumerate(items[:3], 1):
            logger.info(f"\nItem {i}:")
            logger.info(f"  Target: {item.get('target_item')}")
            logger.info(f"  Missing fields: {enricher.detect_missing_fields(item)}")

        logger.info("\n" + "=" * 80)
        logger.info(f"Total items to process: {len(items)}")
        logger.info("DRY RUN COMPLETE")
        logger.info("=" * 80)
        return 0

    # Enrich items
    logger.info(f"\nStarting enrichment of {len(items)} items...")
    enrichment_start = time.time()

    enriched_items = []
    failed_count = 0

    # Get system prompt based on enricher
    system_prompts = {
        "mandarin": mandarin_prompts.SYSTEM_PROMPT,
        "japanese": japanese_prompts.SYSTEM_PROMPT,
        "french": french_prompts.SYSTEM_PROMPT,
    }
    system_prompt = system_prompts.get(args.enricher)

    for i, item in enumerate(items, 1):
        logger.info(f"\nProcessing item {i}/{len(items)}: {item.get('target_item')}")

        try:
            # Set language and level metadata
            item["language"] = args.language
            item["level_system"] = level_system.value
            if "level_min" not in item:
                item["level_min"] = args.level
            if "level_max" not in item:
                item["level_max"] = args.level

            # Enrich item
            result = enricher.enrich_item(
                item=item,
                response_model=LearningItem,
                system_prompt=system_prompt,
            )

            if result:
                enriched_items.append(result.model_dump(mode="json"))
                logger.info(f"  ✓ Successfully enriched")
            else:
                failed_count += 1
                logger.warning(f"  ✗ Failed to enrich (added to manual review)")

        except Exception as e:
            logger.error(f"  ✗ Unexpected error: {e}", exc_info=True)
            failed_count += 1

    enrichment_time = time.time() - enrichment_start

    # Write output
    logger.info(f"\nWriting {len(enriched_items)} enriched items to: {args.output}")
    args.output.parent.mkdir(parents=True, exist_ok=True)

    write_json(enriched_items, args.output)

    # Summary statistics
    logger.info("\n" + "=" * 80)
    logger.info("ENRICHMENT SUMMARY")
    logger.info("=" * 80)
    logger.info(f"Total items processed: {len(items)}")
    logger.info(f"Successfully enriched: {len(enriched_items)}")
    logger.info(f"Failed: {failed_count}")
    logger.info(f"Success rate: {len(enriched_items) / len(items) * 100:.1f}%")
    logger.info(f"Enrichment time: {enrichment_time:.2f}s")
    logger.info(
        f"Average time per item: {enrichment_time / len(items):.2f}s"
    )
    logger.info(f"Output file: {args.output}")
    if failed_count > 0:
        logger.info(f"Manual review queue: {manual_review_dir}")
    logger.info("=" * 80)

    return 0


if __name__ == "__main__":
    sys.exit(main())
